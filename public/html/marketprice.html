<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/e1a2c43e41.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <title>ON-MARKET</title>
    <link rel="stylesheet" href="../css/marketprice.css">
</head>

<body>
    <!-- Firebase and jQuery scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY",
            authDomain: "FIREBASE_AUTH_DOMAIN",
            projectId: "FIREBASE_PROJECT_ID",
            storageBucket: "FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
            appId: "FIREBASE_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <!-- Header -->
    <div class="header">
        <div class="header_wrap">
            <div class="header_content">
                <img src="/images/5572662.png">
                <h1><a href="/" style="color: #f4511e; text-decoration: none;">ON</a></h1>
            </div>

            <div class="header_content">
                <a href="/myprofile.html"><button type="submit" id="basketLink" class="basket_button"><i
                            class="fa-solid fa-cart-shopping"></i></button></a>
                <a href="/myprofile.html"><button type="submit" id="profileLink" class="login_button"><i
                            class="fa-solid fa-user"></i></button></a>
            </div>
        </div>
    </div>

    <!-- Title Section -->
    <div class="title">
        <h2><span class="highlight">ON</span> Market 시세조회</h2><br>
        <p>원하시는 상품이 얼마에 거래되고 있는지 알아보세요</p>
    </div>

    <!-- Search Section -->
    <div class="search-container">
        <div class="select-container">
            <select id="product-category">
                <option value="" disabled selected>카테고리를 선택해주세요</option>
                <option value="디지털기기">디지털기기</option>
                <option value="가구/인테리어">가구/인테리어</option>
                <option value="패션/잡화">패션/잡화</option>
                <option value="생활가전">생활가전</option>
                <option value="생활/주방">생활/주방</option>
                <option value="스포츠/레저">스포츠/레저</option>
                <option value="취미/게임/음반">취미/게임/음반</option>
                <option value="뷰티/미용">뷰티/미용</option>
                <option value="반려동물용품">반려동물용품</option>
                <option value="가공식품">가공식품</option>
                <option value="식물">식물</option>
                <option value="티켓/교환권">티켓/교환권</option>
                <option value="도서">도서</option>
                <option value="기타 중고물품">기타 중고물품</option>
            </select>
        </div>
        <div class="search-box" id="search-box">
            <input type="text" id="product-title" class="search-txt" name="" placeholder="어떤 물품의 시세 정보가 궁금하신가요?">
            <a class="search-btn" href="#">
                <i class="fas fa-search"></i>
            </a>
        </div>
    </div>

    <!-- Result Section -->
    <div class="result-container" id="result-container" style="display: none;">
        <h2>시세금액</h2>
        <div class="price" id="average-price"></div>
        <div class="chart-container" id="chart-container" style="display: none;">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            let priceChart;
            let documentIds = []; // 문서 ID 저장 배열

            function searchProduct() {
                const productTitle = $('#product-title').val().trim().toLowerCase();
                const productCategory = $('#product-category').val();

                if (!productCategory) {
                    alert('카테고리를 먼저 선택해주세요.');
                    return;
                }

                db.collection('product')
                    .where('카테고리', '==', productCategory)
                    .get()
                    .then((querySnapshot) => {
                        let totalPrices = 0;
                        let productCount = 0;
                        let labels = [];
                        let prices = [];

                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const dbTitle = data.제목.trim().toLowerCase();
                            const price = parseFloat(data.가격);
                            const date = data.날짜.toDate();

                            // 제품 제목과 카테고리를 단순화하여 비교 및 무료 나눔 (0원) 제외
                            if (dbTitle.includes(productTitle) && !isNaN(price) && price > 0) {
                                totalPrices += price;
                                productCount++;
                                labels.push(`${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`);
                                prices.push(price);
                                documentIds.push(doc.id); // 문서 ID 저장
                            }
                        });

                        console.log("총 가격: ", totalPrices, "제품 수: ", productCount);

                        if (productCount > 0) {
                            const averagePrice = Math.round(totalPrices / productCount);

                            $('#average-price').text(`${averagePrice.toLocaleString()}원`);
                            $('#result-container').show();
                            $('#chart-container').show();

                            if (priceChart) {
                                priceChart.destroy();
                            }

                            const ctx = document.getElementById('priceChart').getContext('2d');
                            priceChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: '가격',
                                        data: prices,
                                        borderColor: '#4CAF50',
                                        backgroundColor: 'rgba(0, 128, 0, 0.2)',
                                        fill: true,
                                        lineTension: 0.4,
                                        pointBackgroundColor: '#4CAF50',
                                        pointBorderColor: '#4CAF50',
                                        pointHoverBackgroundColor: '#4CAF50',
                                        pointHoverBorderColor: '#4CAF50',
                                        pointRadius: 5,
                                        pointHoverRadius: 7,
                                        borderWidth: 2
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            padding: 12,
                                            bodyFont: {
                                                size: 18
                                            },
                                            titleFont: {
                                                size: 20
                                            },
                                            callbacks: {
                                                label: function (context) {
                                                    return `${context.raw.toLocaleString()} 원`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            ticks: {
                                                color: '#666'
                                            },
                                            grid: {
                                                display: false
                                            }
                                        },
                                        y: {
                                            ticks: {
                                                color: '#666',
                                                callback: function (value) {
                                                    return value.toLocaleString() + ' 원';
                                                }
                                            },
                                            grid: {
                                                borderColor: '#e0e0e0',
                                                borderDash: [5, 5]
                                            },
                                            beginAtZero: true
                                        }
                                    },
                                    onClick: function (e, elements) {
                                        if (elements.length > 0) {
                                            const index = elements[0].index;
                                            const documentId = documentIds[index];
                                            if (confirm('해당 상품의 페이지로 이동하시겠습니까?')) {
                                                window.location.href = `detail.html?id=${documentId}`;
                                            }
                                        }
                                    }
                                }
                            });
                        } else {
                            $('#average-price').text('조회된 물품이 없습니다.');
                            $('#result-container').show();
                            $('#chart-container').hide();
                        }
                    })
                    .catch((error) => {
                        console.error('Error getting documents: ', error);
                    });
            }

            $('.search-btn').on('click', function (e) {
                e.preventDefault();
                searchProduct();
            });

            $('#product-title').on('keypress', function (e) {
                if (e.which === 13) {
                    searchProduct();
                }
            });

            $('#product-title').on('input', function () {
                const searchBox = $('#search-box');
                if ($(this).val().trim().length > 0) {
                    searchBox.addClass('active');
                } else {
                    searchBox.removeClass('active');
                }
            });

            // 페이지 로드 시 입력 필드에 텍스트가 있으면 active 클래스를 추가
            if ($('#product-title').val().trim().length > 0) {
                $('#search-box').addClass('active');
            }
        });
    </script>

    <script>
        $(document).ready(async function () {
            $('#basketLink').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html"; // 로그인 페이지로 리다이렉션
                    } else {
                        window.location.href = "/myprofile.html"; // 로그인이 되어 있다면, myprofile.html로 이동
                    }
                });
            });
            $('#profileLink').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html"; // 로그인 페이지로 리다이렉션
                    } else {
                        window.location.href = "/myprofile.html"; // 로그인이 되어 있다면, myprofile.html로 이동
                    }
                });
            });
        });
    </script>
</body>

</html>