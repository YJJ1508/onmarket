<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/e1a2c43e41.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/images/5572662.png" type="/images/5572662.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <title>ON-MARKET</title>
    <link rel="stylesheet" href="../css/nearbyDetail.css">
</head>

<body>
    <!-- Firebase and jQuery scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=436c9a8a91cd269600b0941715a891c1&libraries=services"></script>

    <!-- Firebase configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY",
            authDomain: "FIREBASE_AUTH_DOMAIN",
            projectId: "FIREBASE_PROJECT_ID",
            storageBucket: "FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
            appId: "FIREBASE_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <!-- Header -->
    <div class="header" style="margin-right: 15px;">
        <div class="header_wrap">
            <div class="header_content">
                <img src="/images/5572662.png" style="width: 80px; margin-top: 8px; padding-right: 10px;">
                <h1 style="margin-top: 19px; font-size: 27px; color: #f4511e; font-weight: bold;"><a href="/"
                        style="color: #f4511e; text-decoration: none;">ON</a></h1>
            </div>

            <div class="header_content">
                <a href="/myprofile.html">
                    <button type="submit" id="basketLink" class="basket_button"><i
                            class="fa-solid fa-cart-shopping"></i></button>
                </a>

                <a href="/myprofile.html">
                    <button type="submit" id="profileLink" class="login_button"><i
                            class="fa-solid fa-user"></i></button>
                </a>
            </div>
        </div>
    </div>

    <!-- Detail Container -->
    <div class="detail_container">
        <div class="detail_images">
            <img id="detail_image1" class="detail_image" src="" alt="">
            <img id="detail_image2" class="detail_image" src="" alt="">
            <img id="detail_image3" class="detail_image" src="" alt="">
        </div>

        <!-- Slide Buttons -->
        <button class="prev" onclick="prevSlide()">&#10094;</button>
        <button class="next" onclick="nextSlide()">&#10095;</button>

        <!-- Product Details -->
        <div class="product_detail">
            <h1 id="detail_seller" class="detail_info"></h1>
            <h1 id="detail_title" class="detail_info"></h1>
            <p id="detail_address" class="detail_info"></p>
            <p id="detail_time" class="detail_info"></p>
            <p id="detail_content" class="detail_info"></p>
            <p id="detail_recommend" class="detail_info"
                style="font-size: 15px; font-weight: bold; color: #eb6060; display: inline-block;"></p>
            <p id="detail_reviews" class="detail_info"
                style="font-size: 15px; font-weight: bold; color: #eb6060; display: inline-block; margin-left: 20px;">
            </p>
            <p id="detail_average_reviews" class="detail_info"
                style="font-size: 15px; font-weight: bold; color: #eb6060; display: inline-block; margin-left: 20px;">
            </p>




            <div class="n">
                <div class="call" style="margin-right: 180px; cursor: pointer;" onclick="showAlert()">
                    <img src="images/phoneicon.png" style="width: 40px; margin-left: 7px; margin-bottom: 12px;">
                    <span style="display: block; font-weight: bold;">전화하기</span>
                </div>

                <div class="chatD"
                    style="margin-right: 180px; display: flex; flex-direction: column; align-items: center;"
                    onclick="openReviewModal()">
                    <img src="images/chaticon.png" style="width: 45px; margin-bottom: 8px;">
                    <span style="display: block;">후기 작성</span>
                </div>


                <button class="recommend">추천하기</button>
            </div>

            <div id="map" style="width: 600px; height:350px; border-radius: 8px;"></div>
            <div id="review_list" class="review_list" style="display: none; width: 600px;"></div>
        </div>
    </div>

    <!-- 모달 창 -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReviewModal()">&times;</span>
            <h2 style="margin-top: 10px;">후기 작성</h2>
            <textarea style="margin-top: 10px;" id="review_text" placeholder="후기를 작성해 주세요 :)" rows="4"></textarea>
            <div class="star-rating" style="margin-bottom: 20px;">
                <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5점">5 stars</label>
                <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4점">4 stars</label>
                <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3점">3 stars</label>
                <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2점">2 stars</label>
                <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1점">1 star</label>
            </div>
            <button class="submit_button" onclick="submitReview()">제출</button>
        </div>
    </div>

    <script>
        // 후기 갯수를 표시하는 함수
        function displayReviewCount() {
            const storeId = getStoreIdFromURL();

            // 해당 상점의 후기 데이터를 가져옵니다.
            db.collection('store')
                .where('후기개수', '==', storeId)
                .get()
                .then((querySnapshot) => {
                    // 후기 갯수를 세고 표시합니다.
                    const reviewCount = querySnapshot.size;
                    document.getElementById('review_count_number').textContent = reviewCount;
                })
                .catch((error) => {
                    console.error('후기 데이터를 가져오는 중 오류 발생:', error);
                });
        }

        // 페이지가 로드될 때 후기 갯수를 표시합니다.
        window.onload = function () {
            const storeId = getStoreIdFromURL();
            fetchPhoneNumber(storeId);
            displayReviewCount(); // 후기 갯수를 표시합니다.
        };


    </script>

    <script>
        $(document).ready(async function () {
            $('.chatD').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html";
                    } else {
                    }
                });
            });
        });
    </script>

    <script>
        $(document).ready(async function () {
            $('#basketLink').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html"; // 로그인 페이지로 리다이렉션
                    } else {
                        window.location.href = "/myprofile.html"; // 로그인이 되어 있다면, myprofile.html로 이동
                    }
                });
            });
            $('#profileLink').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html"; // 로그인 페이지로 리다이렉션
                    } else {
                        window.location.href = "/myprofile.html"; // 로그인이 되어 있다면, myprofile.html로 이동
                    }
                });
            });
        });
    </script>

    <script>
        // 모달 창을 여는 함수
        function openReviewModal() {
            document.getElementById('reviewModal').style.display = 'block';
        }

        // 모달 창을 닫는 함수
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
        }

        // 후기를 제출하는 함수
        function submitReview() {
            const reviewText = document.getElementById('review_text').value;
            const storeId = getStoreIdFromURL();
            const rating = document.querySelector('input[name="rating"]:checked').value; // 사용자가 선택한 별점

            if (reviewText.trim() === '') {
                alert('후기를 작성하세요.');
                return;
            }

            // 후기가 작성되면 해당 상점의 '후기개수' 필드를 증가시킵니다.
            const storeRef = db.collection('store').doc(storeId);

            db.collection('reviews').add({
                storeId: storeId,
                review: reviewText,
                rating: rating, // 별점 저장
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('review_text').value = '';
                closeReviewModal();

                // '후기개수' 및 '총평점' 필드를 증가시킵니다.
                const increment = firebase.firestore.FieldValue.increment(1);
                const incrementRating = firebase.firestore.FieldValue.increment(rating);

                storeRef.update({
                    후기개수: increment,
                    총평점: incrementRating
                }).then(() => {
                    console.log('후기 개수 및 총 평점이 업데이트되었습니다.');

                    document.getElementById('review_text').value = '';
                    closeReviewModal();
                    loadReviews(); // 후기를 제출한 후 다시 로드합니다.
                    showReviews(); // 후기를 제출한 후 리뷰 목록을 표시합니다.
                }).catch((error) => {
                    console.error('후기 개수 또는 총 평점 증가 중 오류 발생:', error);
                });
            }).catch((error) => {
                console.error('후기 제출 중 오류 발생:', error);
            });
        }

        // 후기를 로드하는 함수
        function loadReviews() {
            const storeId = getStoreIdFromURL();
            const reviewList = document.getElementById('review_list');
            reviewList.innerHTML = '';

            db.collection('reviews')
                .where('storeId', '==', storeId)
                .orderBy('timestamp', 'desc')
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const reviewItem = document.createElement('div');
                        reviewItem.className = 'review_item';

                        //후기 등급 추가
                        const reviewRating = document.createElement('p');
                        reviewRating.textContent = `평점: ${data.rating}`;
                        reviewItem.appendChild(reviewRating);

                        // 후기 텍스트 추가
                        const reviewText = document.createElement('p');
                        reviewText.textContent = data.review;
                        reviewItem.appendChild(reviewText);

                        // 별점 표시
                        const starRating = document.createElement('div');
                        starRating.className = 'star-rating';
                        for (let i = 1; i <= 5; i++) {
                            const star = document.createElement('span');
                            star.className = 'fa fa-star';
                            if (i <= data.rating) {
                                star.classList.add('checked');
                            }
                            starRating.appendChild(star);
                        }
                        reviewItem.appendChild(starRating);

                        reviewList.appendChild(reviewItem);
                    });
                }).catch((error) => {
                    console.error('후기 로드 중 오류 발생:', error);
                });
        }


        // 카카오맵을 숨기고 후기를 표시하는 함수
        function showReviews() {
            document.getElementById('map').style.display = 'none';
            document.getElementById('review_list').style.display = 'block';
        }

        // 페이지가 로드될 때 후기를 로드합니다.
        window.onload = function () {
            const storeId = getStoreIdFromURL();
            fetchPhoneNumber(storeId);
            loadReviews(); // 페이지 로드 시 후기를 로드합니다.
        };

        // 전화번호를 가져오는 함수
        function fetchPhoneNumber(storeId) {
            db.collection("store").doc(storeId).get().then((doc) => {
                if (doc.exists) {
                    phoneNumber = doc.data().전화번호;
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            });
        }

        // 전화번호를 알림으로 표시하는 함수
        function showAlert() {
            alert('전화번호: ' + phoneNumber);
        }

    </script>


    <!-- JavaScript -->
    <script>
        let currentSlide = 0;
        const slideWidth = 400; // 이미지의 고정된 너비와 동일하게 설정

        $(document).ready(function () {
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('id');

            db.collection('store').doc(storeId).get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();

                    // 상점 상세 정보를 HTML에 적용
                    $('#detail_title').text(data.상호명);
                    $('#detail_image1').attr('src', data.로고);
                    $('#detail_image2').attr('src', data.이미지1);
                    $('#detail_image3').attr('src', data.이미지2);
                    $('#detail_address').text('주소: ' + data.위치);
                    $('#detail_time').text('영업시간: ' + data.영업시간);
                    var info = data.정보;
                    if (info.length > 37) {
                        var splitInfo = info.match(/.{1,42}/g).join("<br>");
                        info = splitInfo;
                    }
                    $('#detail_content').html(info);
                    $('#detail_recommend').text('추천: ' + data.개추데이터);
                    $('#detail_reviews').text('후기: ' + data.후기개수);
                    $('#detail_average_reviews').text('평점: ' + (data.총평점 / data.후기개수).toFixed(1));


                    // 주소로 좌표를 검색하여 지도에 표시
                    var mapContainer = document.getElementById('map');
                    var mapOption = {
                        center: new kakao.maps.LatLng(33.450701, 126.570667),
                        level: 3
                    };
                    var map = new kakao.maps.Map(mapContainer, mapOption);

                    var geocoder = new kakao.maps.services.Geocoder();

                    geocoder.addressSearch(data.위치, function (result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            var marker = new kakao.maps.Marker({ map: map, position: coords });
                            map.setCenter(coords, marker);
                        }
                    });
                } else {
                    console.log("상점 정보가 없습니다.");
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            });
        });

        function showSlide(n) {
            const images = document.querySelectorAll('.detail_image');
            if (n >= images.length) { currentSlide = 0; }
            if (n < 0) { currentSlide = images.length - 1; }

            images.forEach(image => image.style.transform = `translateX(-${currentSlide * slideWidth}px)`);
        }

        function nextSlide() {
            currentSlide++;
            showSlide(currentSlide);
        }

        function prevSlide() {
            currentSlide--;
            showSlide(currentSlide);
        }

        // 채팅 데이터 값을 증가시키는 함수
        function increaseChatData() {
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('id');

            const productRef = db.collection('store').doc(storeId);

            productRef.get().then((docSnapshot) => {
                if (docSnapshot.exists) {
                    productRef.update({
                        개추데이터: firebase.firestore.FieldValue.increment(1)
                    }).then(() => {
                        console.log("개추 데이터 값이 증가되었습니다.");
                    }).catch((error) => {
                        console.log("개추 데이터 값 증가에 실패하였습니다.", error);
                    });
                } else {
                    productRef.set({
                        개추데이터: 0
                    }).then(() => {
                        console.log("개추 데이터 필드가 새로 생성되었습니다.");
                    }).catch((error) => {
                        console.log("개추 데이터 필드 생성에 실패하였습니다.", error);
                    });
                }
            }).catch((error) => {
                console.log("Error checking document:", error);
            });
        }

        $(document).on('click', '.recommend', function () {
            increaseChatData();
        });

        function getStoreIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('id');
            return storeId;
        }

        let phoneNumber = '';

        function fetchPhoneNumber(storeId) {
            db.collection("store").doc(storeId).get().then((doc) => {
                if (doc.exists) {
                    phoneNumber = doc.data().전화번호;
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            });
        }

        window.onload = function () {
            const storeId = getStoreIdFromURL();
            fetchPhoneNumber(storeId);
        };

        function showAlert() {
            alert('전화번호: ' + phoneNumber);
        }

    </script>
</body>

</html>