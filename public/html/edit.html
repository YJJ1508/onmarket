<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/e1a2c43e41.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>ON-MARKET</title>
    <link rel="stylesheet" href="../css/edit.css">
</head>

<body>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY",
            authDomain: "FIREBASE_AUTH_DOMAIN",
            projectId: "FIREBASE_PROJECT_ID",
            storageBucket: "FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
            appId: "FIREBASE_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
    </script>

    <div class="header" style="margin-right: 15px;">
        <div class="header_wrap">
            <div class="header_content">
                <img src="/images/5572662.png" style="width: 80px; margin-top: 8px; padding-right: 10px;">
                <h1 style="margin-top: 19px; font-size: 27px; color: #f4511e; font-weight: bold;"><a href="/"
                        style="color: #f4511e; text-decoration: none;">ON</a></h1>
            </div>

            <div class="header_content">
                <a href="/myprofile.html">
                    <button type="submit" id="basketLink" class="basket_button"><i
                            class="fa-solid fa-cart-shopping"></i></button>
                </a>

                <a href="/myprofile.html">
                    <button type="submit" id="profileLink" class="login_button"><i
                            class="fa-solid fa-user"></i></button>
                </a>
            </div>
        </div>
    </div>

    <div class="container mt-3">
        <!-- Category selection -->
        <select class="form-control mt-2" id="category" style="margin-bottom: 30px;">
            <option value="" disabled selected>카테고리를 선택하세요</option>
            <option value="디지털기기">디지털기기</option>
            <option value="가구/인테리어">가구/인테리어</option>
            <option value="패션/잡화">패션/잡화</option>
            <option value="생활가전">생활가전</option>
            <option value="생활/주방">생활/주방</option>
            <option value="스포츠/레저">스포츠/레저</option>
            <option value="취미/게임/음반">취미/게임/음반</option>
            <option value="뷰티/미용">뷰티/미용</option>
            <option value="반려동물용품">반려동물용품</option>
            <option value="가공식품">가공식품</option>
            <option value="식물">식물</option>
            <option value="티켓/교환권">티켓/교환권</option>
            <option value="도서">도서</option>
            <option value="기타 중고물품">기타 중고물품</option>
        </select>
        <input type="text" class="form-control mt-2" id="title" placeholder="제품 이름" style="margin-bottom: 30px;">
        <textarea class="form-control mt-2" id="content" placeholder="제품 설명" style="margin-bottom: 30px;"></textarea>
        <input type="text" class="form-control mt-2" id="price" placeholder="가격" style="margin-bottom: 20px;">
        <div class="form-check mt-2" style="margin-bottom: 20px;">
            <input class="form-check-input" type="checkbox" id="free" value="free">
            <label class="form-check-label" for="free">
                무료 나눔
            </label>
        </div>
        <input type="text" class="form-control mt-2" id="address" placeholder="주소를 입력하세요!" style="margin-bottom: 30px;">

        <p style="margin-top: 20px; margin-bottom: 30px; font-size: 20px; font-weight: 500;">변경할 사진을 3장 업로드 해주세요!</p>

        <div class="image-upload-container mt-2">
            <div class="image-upload">
                <input class="form-control" type="file" id="image1" onchange="previewImages(event, 'preview1')">
                <div class="image-preview mt-2" id="preview1"></div>
            </div>

            <div class="image-upload">
                <input class="form-control" type="file" id="image2" onchange="previewImages(event, 'preview2')">
                <div class="image-preview mt-2" id="preview2"></div>
            </div>

            <div class="image-upload">
                <input class="form-control" type="file" id="image3" onchange="previewImages(event, 'preview3')">
                <div class="image-preview mt-2" id="preview3"></div>
            </div>
        </div>

        <button class="btn btn-danger mt-3" id="complete">저장하기</button>
    </div>

    <script>
        function previewImages(event, id) {
            var reader = new FileReader();
            reader.onload = function () {
                var output = document.getElementById(id);
                output.innerHTML = '';
                var img = document.createElement('img');
                img.src = reader.result;
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.objectFit = 'cover';
                img.style.marginRight = '10px';
                img.style.marginBottom = '10px';
                img.style.borderRadius = '5px';
                img.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
                output.appendChild(img);
            }
            reader.readAsDataURL(event.target.files[0]);
        }
    </script>

    <script>
        $(document).ready(async function () {
            $('#basketLink').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html"; // 로그인 페이지로 리다이렉션
                    } else {
                        window.location.href = "/myprofile.html"; // 로그인이 되어 있다면, myprofile.html로 이동
                    }
                });
            });
            $('#profileLink').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html"; // 로그인 페이지로 리다이렉션
                    } else {
                        window.location.href = "/myprofile.html"; // 로그인이 되어 있다면, myprofile.html로 이동
                    }
                });
            });
        });
    </script>

    <script>
        const db = firebase.firestore();
        const storage = firebase.storage();

        var 쿼리스트링 = new URLSearchParams(window.location.search);

        db.collection('product').doc(쿼리스트링.get('id')).get().then((result) => {

            $('#category').val(result.data().카테고리)
            $('#title').val(result.data().제목)
            $('#content').val(result.data().내용)
            $('#price').val(result.data().가격)
            $('#address').val(result.data().주소)
            $('#free').prop('checked', result.data().무료나눔);

            // 이미지 URL 가져오기
            var imageUrls = [result.data().이미지1, result.data().이미지2, result.data().이미지3];

            // 이미지를 화면에 표시
            imageUrls.forEach((imageUrl, index) => {
                var img = `<img src="${imageUrl}" alt="제품 이미지 ${index + 1}">`;
                $(`#preview${index + 1}`).html(img);
            });
        });

        $('#complete').click(function () {
            var category = $('#category').val();
            if (!category) {
                alert('카테고리를 선택해주세요.');
                return;
            }

            var 수정내용 = {
                카테고리: $('#category').val(),
                제목: $('#title').val(),
                내용: $('#content').val(),
                가격: $('#price').val(),
                주소: $('#address').val(),
                무료나눔: $('#free').is(":checked")
            };

            var 이미지1 = $('#image1')[0].files[0];
            var 이미지2 = $('#image2')[0].files[0];
            var 이미지3 = $('#image3')[0].files[0];

            var 이미지업로드작업들 = [];

            var confirmation = confirm("변경된 내용을 저장하시겠습니까?");
            if (confirmation) {
                if (이미지1) {
                    var 이미지1Ref = storage.ref('images/' + 이미지1.name);
                    var 이미지1업로드작업 = 이미지1Ref.put(이미지1);
                    이미지업로드작업들.push(
                        이미지1업로드작업.then(() => 이미지1Ref.getDownloadURL()).then(url => {
                            수정내용.이미지1 = url;
                        })
                    );
                }

                if (이미지2) {
                    var 이미지2Ref = storage.ref('images/' + 이미지2.name);
                    var 이미지2업로드작업 = 이미지2Ref.put(이미지2);
                    이미지업로드작업들.push(
                        이미지2업로드작업.then(() => 이미지2Ref.getDownloadURL()).then(url => {
                            수정내용.이미지2 = url;
                        })
                    );
                }

                if (이미지3) {
                    var 이미지3Ref = storage.ref('images/' + 이미지3.name);
                    var 이미지3업로드작업 = 이미지3Ref.put(이미지3);
                    이미지업로드작업들.push(
                        이미지3업로드작업.then(() => 이미지3Ref.getDownloadURL()).then(url => {
                            수정내용.이미지3 = url;
                        })
                    );
                }

                Promise.all(이미지업로드작업들).then(() => {
                    db.collection('product').doc(쿼리스트링.get('id')).update(수정내용).then(function () {
                        window.location.href = `detail.html?id=${쿼리스트링.get('id')}`;
                    });
                }).catch(function (error) {
                    console.error('업데이트 중 오류 발생: ', error);
                });
            } else {
                return false;
            }
        });
    </script>
</body>

</html>