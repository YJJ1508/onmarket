<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/e1a2c43e41.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/chatstyle.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght@48,400,1,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/images/5572662.png" type="/images/5572662.png">
    <style>
        .filter-container {
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 25px;
            padding: 10px 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .filter-container:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .filter-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 25px;
            background-color: #ffffff;
            outline: none;
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease;
        }

        .filter-input:focus {
            background-color: #ffffff;
        }

        .filter-container i {
            margin-right: 10px;
            color: #888;
            transition: color 0.3s ease;
        }

        .filter-container:hover i {
            color: #555;
        }

        .contacts {
            height: 100vh;
            padding: 10px;
        }

        .contact {
            margin-top: 10px;
        }

        .chat_list {
            list-style-type: none;
            padding: 0;
        }

        /* ì±„íŒ… ì´ìš© ì•ˆë‚´ë¬¸êµ¬ css */
        .alert {
            padding: 8px 16px;
            background-color: #f8f8f8;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            border-radius: 12px;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }

    </style>
    <title>ON-MARKET</title>
</head>

<body>
    <!-- Firebase and jQuery scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Firebase configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY",
            authDomain: "FIREBASE_AUTH_DOMAIN",
            projectId: "FIREBASE_PROJECT_ID",
            storageBucket: "FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
            appId: "FIREBASE_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
    </script>

    <!-- Chat Container -->
    <div class="center">
        <div class="contacts">
            <div class="filter-container">
                <i class="fas fa-search"></i>
                <input type="text" id="filterInput" class="filter-input" placeholder="ë¬¼í’ˆì´ë‚˜ ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">
            </div>
            <div class="contact">
                <ul class="chat_list"></ul>
            </div>
        </div>

        <div class="chat">
            <div class="contact_bar">
                <div class="left_bar"></div>
                <div class="right_bar2" style="display: flex; align-items: center; justify-content: space-between;">
                    <div class="right_bar_pay"></div>
                </div>
            </div>

            <!-- ë©”ì„¸ì§€ ì´ìš© ì•ˆë‚´ -->
            <div class="alert">
                íƒ€ì¸ì— ëŒ€í•œ ìš•ì„¤,ë¹„ë°© ë“± ë¶€ì ì ˆí•œ í–‰ìœ„ëŠ” ì´ìš©ì— ì œí•œì´ ë  ìˆ˜ ìˆìœ¼ë©°, ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ë¯¼ê°í•œ ì •ë³´ë¥¼ ê³µìœ í•˜ì§€ ì•Šê¸°ë¥¼ ë°”ëë‹ˆë‹¤.
            </div>

            <div class="messages">
                <ul class="chat_content"></ul>
            </div>

            <div class="input">
                <i class="fas fa-camera" id="camera" title="ì‚¬ì§„ ì˜¬ë¦¬ê¸°"></i>
                <i class="far fa-laugh-beam" id="laugh" title="ì´ëª¨í‹°ì½˜"></i>
                <input class="chat_form" id="chat_input" placeholder="ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." type="text" />
                <i class="far fa-paper-plane" id="send" title="ì „ì†¡í•˜ê¸°"></i>
                <i class="fas fa-language" id="translate" title="ë²ˆì—­í•˜ê¸°"></i>
            </div>
            <div class="emojis" id="emojis">
                <div class="emoji-group">
                    <i class="far fa-grin-squint-tears" data-emoji="ğŸ˜‚"></i>
                    <i class="far fa-laugh-beam" data-emoji="ğŸ˜†"></i>
                    <i class="far fa-kiss-wink-heart" data-emoji="ğŸ˜˜"></i>
                    <i class="far fa-angry" data-emoji="ğŸ˜¡"></i>
                    <i class="far fa-sad-tear" data-emoji="ğŸ˜¢"></i>
                    <i class="far fa-grin-squint" data-emoji="ğŸ˜„"></i>
                    <i class="far fa-grin-beam-sweat" data-emoji="ğŸ˜…"></i>
                    <i class="far fa-grin-alt" data-emoji="ğŸ˜"></i>
                    <i class="far fa-grin" data-emoji="ğŸ˜€"></i>
                    <i class="far fa-grin-tongue" data-emoji="ğŸ˜›"></i>
                    <i class="far fa-sad-cry" data-emoji="ğŸ˜­"></i>
                    <i class="far fa-grimace" data-emoji="ğŸ˜¬"></i>
                    <i class="far fa-grin-stars" data-emoji="ğŸ¤©"></i>
                    <i class="far fa-tired" data-emoji="ğŸ˜«"></i>
                    <i class="far fa-surprise" data-emoji="ğŸ˜²"></i>
                    <i class="far fa-meh" data-emoji="ğŸ˜"></i>
                    <i class="far fa-frown" data-emoji="ğŸ˜"></i>
                    <i class="far fa-dizzy" data-emoji="ğŸ˜µ"></i>
                    <i class="far fa-flushed" data-emoji="ğŸ˜³"></i>
                    <i class="far fa-grin-tongue-wink" data-emoji="ğŸ˜œ"></i>
                    <i class="far fa-grin-tongue-squint" data-emoji="ğŸ˜"></i>
                    <i class="far fa-grin-wink" data-emoji="ğŸ˜‰"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ì°½ -->
    <div id="imageModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
        <div id="caption"></div>
    </div>

    <!-- JavaScript -->
    <script>
        const apiKey = "GOOGLE_CLOUD_API_KEY"; // êµ¬ê¸€ í´ë¼ìš°ë“œ API KEY 

        // API í˜¸ì¶œì„ ì¤„ì´ê¸° ìœ„í•´ ì´ë¯¸ ë²ˆì—­í•œ ë©”ì„¸ì§€ì— ëŒ€í•œ ìºì‹± ë¡œì§
        const translationCache = new Map();

        async function translateText(text, targetLang) {
            if (translationCache.has(text)) {
                return translationCache.get(text);
            }

            const url = `https://translation.googleapis.com/language/translate/v2?key=${apiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                body: JSON.stringify({
                    q: text,
                    target: targetLang
                }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            const translatedText = data.data.translations[0].translatedText;
            translationCache.set(text, translatedText);
            return translatedText;
        }

        // íŠ¹ìˆ˜ ë¬¸ìë„ ì œëŒ€ë¡œ ë²ˆì—­ë˜ë„ë¡ 
        function decodeHTMLEntities(text) {
            var textArea = document.createElement('textarea');
            textArea.innerHTML = text;
            return textArea.value;
        }

        document.getElementById('translate').addEventListener('click', async () => {
            const text = document.getElementById('chat_input').value;
            if (text) {
                const isKorean = /[\u3131-\uD79D]/ugi.test(text);
                const targetLang = isKorean ? 'en' : 'ko';
                const confirmMessage = isKorean ? 'ë©”ì„¸ì§€ë¥¼ ë²ˆì—­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'Would you like to translate the message?';
                const userConfirmed = confirm(confirmMessage);
                if (userConfirmed) {
                    const translatedText = await translateText(text, targetLang);
                    document.getElementById('chat_input').value = decodeHTMLEntities(translatedText);
                }
            }
        });

        var ë‚´uid = JSON.parse(localStorage.getItem('user')).uid;
        var ì±„íŒ…ë°©id, ì±„íŒ…ë°ì´í„°;
        var chatList = [];

        db.collection('chat').where('who', 'array-contains', ë‚´uid).get().then((result) => {
            let ì±„íŒ…ë°©ì´ìˆìŒ = false;
            let ì±„íŒ…ë°©Promises = [];

            result.forEach((a) => {
                ì±„íŒ…ë°©ì´ìˆìŒ = true;
                var ì±„íŒ…ë°©id = a.id;

                // ì±„íŒ…ë°© ì •ë³´ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                console.log("ì±„íŒ…ë°© ë°ì´í„°: ", a.data());

                // í•´ë‹¹ ì±„íŒ…ë°©ì˜ messages ì»¬ë ‰ì…˜ì—ì„œ ìµœê·¼ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                let promise = db.collection('chat').doc(ì±„íŒ…ë°©id).collection('messages').orderBy('date', 'desc').limit(1).get().then((querySnapshot) => {
                    var ìµœê·¼ë©”ì‹œì§€ = "";
                    var ìµœê·¼ë‚ ì§œ = null;
                    querySnapshot.forEach((doc) => {
                        if (doc.data().type === 'image') {
                            ìµœê·¼ë©”ì‹œì§€ = "ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.";
                        } else {
                            ìµœê·¼ë©”ì‹œì§€ = doc.data().content.length > 20 ? doc.data().content.slice(0, 20) + '...' : doc.data().content;
                        }
                        ìµœê·¼ë‚ ì§œ = doc.data().date.toDate();
                    });

                    var ìƒëŒ€ë°©ì´ë¦„;

                    console.log("íŒë§¤ìuid: ", íŒë§¤ìuid);
                    console.log("ë‚´uid: ", ë‚´uid);

                    var íŒë§¤ìuid = a.data().who[1]; 
                    if (íŒë§¤ìuid === ë‚´uid) {
                        console.log("êµ¬ë§¤ì ì´ë¦„ì„ ì‚¬ìš©");
                        ìƒëŒ€ë°©ì´ë¦„ = a.data().êµ¬ë§¤ì_ì´ë¦„;
                    } else {
                        console.log("íŒë§¤ì ì´ë¦„ì„ ì‚¬ìš©");
                        ìƒëŒ€ë°©ì´ë¦„ = a.data().íŒë§¤ì_ì´ë¦„;
                    }
                    console.log("ìƒëŒ€ë°©ì´ë¦„: ", ìƒëŒ€ë°©ì´ë¦„);

                    var chatItem = {
                        id: ì±„íŒ…ë°©id,
                        image: a.data().ì´ë¯¸ì§€1,
                        name: ìƒëŒ€ë°©ì´ë¦„,
                        recentMessage: ìµœê·¼ë©”ì‹œì§€,
                        recentDate: ìµœê·¼ë‚ ì§œ,
                        productName: a.data().product,
                        dateCreated: a.data().date 
                    };

                    chatList.push(chatItem);
                });

                ì±„íŒ…ë°©Promises.push(promise);
            });

            if (!ì±„íŒ…ë°©ì´ìˆìŒ) {
                alert('ì±„íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
            } else {
                Promise.all(ì±„íŒ…ë°©Promises).then(() => {
                    updateChatList();

                    // URLì—ì„œ ì±„íŒ…ë°© ID ì¶”ì¶œ
                    const urlParams = new URLSearchParams(window.location.search);
                    const chatIdFromUrl = urlParams.get('chatId');

                    if (chatIdFromUrl) {
                        const chatExists = chatList.some(chat => chat.id === chatIdFromUrl);
                        if (chatExists) {
                            $(`.chat_list_info[data-chatid="${chatIdFromUrl}"]`).click();
                        } else if (chatList.length > 0) {
                            const sortedChatList = chatList.sort((a, b) => b.dateCreated - a.dateCreated);
                            const recentChatId = sortedChatList[0].id;
                            $(`.chat_list_info[data-chatid="${recentChatId}"]`).click();
                        }
                    } else if (chatList.length > 0) {
                        const sortedChatList = chatList.sort((a, b) => b.dateCreated - a.dateCreated);
                        const recentChatId = sortedChatList[0].id;
                        $(`.chat_list_info[data-chatid="${recentChatId}"]`).click();
                    }
                });
            }
        });
        

        function updateChatList() {
            var filter = $('#filterInput').val().toLowerCase();
            var filteredChatList = chatList.filter(chat => chat.name.toLowerCase().includes(filter) || chat.productName.toLowerCase().includes(filter));
            var sortedChatList = filteredChatList.sort((a, b) => b.dateCreated - a.dateCreated); // dateCreated ê¸°ì¤€ìœ¼ë¡œ ì±„íŒ…ë°© ì •ë ¬
            $('.chat_list').html('');
            sortedChatList.forEach(chat => {
                var template = `<li class="chat_list_info" data-chatid="${chat.id}">
                    <div class="product_info">
                        <div class="product_pic">
                            <img src="${chat.image}" data-image="${chat.image}" style="width: 70px; height: 70px; border-radius: 50%; padding-left: 5px;">
                        </div>
                        <div class="user_info">
                            <h6 class="user_name">${chat.name}</h6>
                            <h6 class="recent_message">${chat.recentMessage}</h6> 
                        </div>
                    </div>
                </li>`;
                $('.chat_list').append(template);
            });
        }

        $(document).on('input', '#filterInput', function () {
            updateChatList();
        });

        $(document).on('click', '.chat_list_info', function (e) {
            e.stopImmediatePropagation();

            // í˜„ì¬ í´ë¦­ëœ ì±„íŒ…ë°©ì„ êµ¬ë³„í•˜ëŠ” ë¡œì§
            $('.chat_list_info').removeClass('active');
            $(this).addClass('active');

            ì±„íŒ…ë°©id = $(this).data('chatid');

            // URL ì—…ë°ì´íŠ¸
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('chatId', ì±„íŒ…ë°©id);
            window.history.pushState({ path: newUrl.href }, '', newUrl.href);

            var ì´ì „_ë‚ ì§œ = null;

            db.collection('chat').doc(ì±„íŒ…ë°©id).collection('messages').orderBy('date').onSnapshot((result) => {
                $('.chat_content').html('');
                var ì´ì „_ë‚ ì§œ = null;
                result.forEach((a, index) => {
                    var ë‚ ì§œ = a.data().date.toDate();
                    var ì‹œê°„ = (ë‚ ì§œ.getHours() % 12 || 12);
                    var ë¶„ = (ë‚ ì§œ.getMinutes() < 10 ? '0' : '') + ë‚ ì§œ.getMinutes();
                    var ì˜¤ì „ì˜¤í›„ = (ë‚ ì§œ.getHours() < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„');
                    var ì‹œê°„ë¬¸ìì—´ = ì˜¤ì „ì˜¤í›„ + ' ' + ì‹œê°„ + ':' + ë¶„;
                    var ë‚ ì§œë¬¸ìì—´ = `${('0' + (ë‚ ì§œ.getMonth() + 1)).slice(-2)}.${('0' + ë‚ ì§œ.getDate()).slice(-2)}`;

                    if (a.data().uid == ë‚´uid) {
                        var í…œí”Œë¦¿ = `<li class="message-container mine">
                                        <div class="message-content">
                                            ${a.data().type == 'image' ? `<img src="${a.data().content}" alt="">` : a.data().content}
                                            <small>${ë‚ ì§œë¬¸ìì—´} ${ì‹œê°„ë¬¸ìì—´}</small>
                                        </div>
                                    </li>`;
                    } else {
                        var í…œí”Œë¦¿ = `<li class="message-container">
                                        <div class="message-content">
                                            ${a.data().type == 'image' ? `<img src="${a.data().content}" alt="">` : a.data().content}
                                            <small>${ë‚ ì§œë¬¸ìì—´} ${ì‹œê°„ë¬¸ìì—´}</small>
                                        </div>
                                    </li>`;
                    }
                    $('.chat_content').append(í…œí”Œë¦¿);

                    ì´ì „_ë‚ ì§œ = ë‚ ì§œ;
                });
                $('.chat_content').scrollTop($('.chat_content')[0].scrollHeight);
            });

            db.collection('chat').doc(ì±„íŒ…ë°©id).get().then((snapshot) => {
                var ë¬¼í’ˆì´ë¦„ = snapshot.data().product;
                var ë¬¼í’ˆì´ë¯¸ì§€ = snapshot.data().ì´ë¯¸ì§€1;

                $('.left_bar').html(`
                    <div class="left_bar">
                        <img src="${ë¬¼í’ˆì´ë¯¸ì§€}" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">&nbsp
                        <h5 class="product_name">${ë¬¼í’ˆì´ë¦„}</h5>
                        <i class="fas fa-sign-out-alt" id="leave" style="margin-left: 10px; cursor: pointer;"></i>
                        <i class="fas fa-ban" id="report" style="margin-left: 10px; cursor: pointer;" title="ì‹ ê³ í•˜ê¸°"></i>
                    </div>`);

                $('.right_bar2').html(`
                    <div class="right_bar_pay">
                        <button id= "payBtn" style="display: inline-flex; align-items: center; background-color: white; color: black; border: 1px solid lightgrey; border-radius: 5px; padding: 8px 15px; text-decoration: none; font-size: 16px; margin: 3px; margin-right: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                            <img width="30px" height="30px" src="https://img.icons8.com/ios-glyphs/30/won.png" alt="won" />
                            ê²°ì œí•˜ê¸°
                        </button>
                    </div>
                    <div class="right_bar_image" sytle="margin-left: 30px"> 
                        <a href="index.html">
                        <img src="/images/5572662.png" style="width: 50px; padding-left:20px height: 50px;" title="ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™">
                    </a>
                    </div>
                `);  
            });
        });
        //ê²°ì œí•˜ê¸° ë²„íŠ¼ ëˆŒë €ì„ ë•Œ 
        $('.right_bar2').on('click', '#payBtn', function() {
            //chatId ì €ì¥
            var urlParams = new URLSearchParams(window.location.search);
            var chatId = urlParams.get("chatId");
            localStorage.setItem("chatId", JSON.stringify(chatId));
            window.location.href = "pay.html";
        })

        $('#send').click(function () {
            var ì…ë ¥ê°’ = $('#chat_input').val();
            var ì±„íŒ…ë°ì´í„°;
            if (ì…ë ¥ê°’.startsWith('http')) {
                ì±„íŒ…ë°ì´í„° = {
                    content: ì…ë ¥ê°’,
                    date: new Date(),
                    uid: ë‚´uid,
                    type: 'image'
                }
            } else {
                ì±„íŒ…ë°ì´í„° = {
                    content: ì…ë ¥ê°’,
                    date: new Date(),
                    uid: ë‚´uid,
                    type: 'text'
                }
            }
            db.collection('chat').doc(ì±„íŒ…ë°©id).collection('messages').add(ì±„íŒ…ë°ì´í„°)
                .then(() => {
                    $('#chat_input').val('');

                    var ìµœê·¼ë©”ì‹œì§€ = ì…ë ¥ê°’.startsWith('http') ? "ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤." : ì…ë ¥ê°’.length > 20 ? ì…ë ¥ê°’.slice(0, 20) + '...' : ì…ë ¥ê°’;
                    $('.chat_list_info[data-chatid="' + ì±„íŒ…ë°©id + '"] .recent_message').text(ìµœê·¼ë©”ì‹œì§€);
                })
                .catch((error) => {
                    console.error("Error: ", error);
                });
        });

        $('#chat_input').keypress(function (event) {
            if (event.which == 13) {
                event.preventDefault();
                $('#send').click();
            }
        });

        $('#chat_input').focus(function () {
            $('#emojis').hide();
        });

        $('#camera').click(function () {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                var file = e.target.files[0];
                var ref = storage.ref('chat_images/' + file.name);
                ref.put(file).then(() => {
                    ref.getDownloadURL().then(url => {
                        $('#chat_input').val(url);
                    });
                });
            };
            input.click();
        });

        $('#laugh').click(function () {
            $('#emojis').toggle();
        });

        $('.emojis i').click(function () {
            var ì´ëª¨ì§€ = $(this).data('emoji');
            $('#chat_input').val($('#chat_input').val() + ì´ëª¨ì§€);
        });

        $(document).on('click', '.message img', function () {
            var imageUrl = $(this).attr('src');
            window.open(imageUrl, '_blank');
        });

        $(document).on('click', '.message_mine img', function () {
            var imageUrl = $(this).attr('src');
            window.open(imageUrl, '_blank');
        });

        $(document).on('click', '#leave', function () {
            if (confirm('ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // í•˜ìœ„ ì»¬ë ‰ì…˜ ì‚­ì œ í›„ ì±„íŒ…ë°© ì‚­ì œ
                const messagesRef = db.collection('chat').doc(ì±„íŒ…ë°©id).collection('messages');
                
                messagesRef.get().then((querySnapshot) => {
                    const batch = db.batch();
                    
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    return batch.commit();
                }).then(() => {
                    return db.collection('chat').doc(ì±„íŒ…ë°©id).delete();
                }).then(() => {
                    alert('ì±„íŒ…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    db.collection('chat').where('who', 'array-contains', ë‚´uid).get().then((result) => {
                        if (!result.empty) {
                            location.reload();
                        } else {
                            window.location.href = 'index.html';
                        }
                    }).catch((error) => {
                        console.error("Error getting documents: ", error);
                    });
                }).catch((error) => {
                    console.error("Error removing document: ", error);
                });
            }
        });

        document.addEventListener('click', function (event) {
            if (event.target.id === 'report') {
                if (confirm('ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    const chatId = ì±„íŒ…ë°©id; 
                    const reportRef = db.collection('report').doc(); 

                    db.collection('chat').doc(chatId).get().then((snapshot) => {
                        const chatData = snapshot.data();
                        const ìƒëŒ€ë°©uid = chatData.who.find(uid => uid !== ë‚´uid); 

                        reportRef.set({
                            chatId: chatId,
                            ì‹ ê³ ì: ë‚´uid,
                            ì‹ ê³ ëŒ€ìƒ: ìƒëŒ€ë°©uid, 
                            reportedAt: firebase.firestore.FieldValue.serverTimestamp()
                        })
                        .then(() => {
                            const reportMessagesRef = reportRef.collection('reportmessages');

                            db.collection('chat').doc(chatId).collection('messages').get()
                            .then((querySnapshot) => {
                                querySnapshot.forEach((doc) => {
                                    reportMessagesRef.add(doc.data());
                                });
                            })
                            .catch((error) => {
                                console.error('Error getting messages: ', error);
                            });
                            alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        })
                    .catch((error) => {
                        console.error('Error reporting chat: ', error);
                    });
                }).catch((error) => {
                    console.error('Error getting chat data: ', error);
                    });
                }
            }
        });

        // ë©”ì„¸ì§€ì— í¬í•¨ëœ ì´ë¯¸ì§€ í´ë¦­ì‹œ ì´ë²¤íŠ¸
        $(document).on('click', '.message-content img', function () {
            var modal = document.getElementById("imageModal");
            var modalImg = document.getElementById("modalImage");
            var captionText = document.getElementById("caption");

            modal.style.display = "block";
            modalImg.src = this.src;
            captionText.innerHTML = this.alt;
        });

        // ì´ë¯¸ì§€ ë‹«ê¸°
        var modal = document.getElementById("imageModal");
        var span = document.getElementsByClassName("close")[0];
        span.onclick = function () {
            modal.style.display = "none";
        }
    </script>
</body>

</html>