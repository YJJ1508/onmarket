<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/e1a2c43e41.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/images/5572662.png" type="/images/5572662.png">
    <link rel="icon" href="/images/5572662.png" type="/images/5572662.png">
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous">
        </script>
    <script>
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY",
            authDomain: "FIREBASE_AUTH_DOMAIN",
            projectId: "FIREBASE_PROJECT_ID",
            storageBucket: "FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
            appId: "FIREBASE_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    <title>ON-MARKET</title>
    <link rel="stylesheet" href="../css/searchResults.css">
</head>

<body>
    <div class="header" style="margin-right: 15px;">
        <div class="header_wrap">
            <div class="header_content">
                <img src="/images/5572662.png" style="width: 80px; margin-top: 8px; padding-right: 10px;">
                <h1 style="margin-top: 19px; font-size: 27px; color: #f4511e; font-weight: bold;"><a href="/"
                        style="color: #f4511e; text-decoration: none;">ON</a></h1>
            </div>

            <div class="header_content">
                <a href="#">
                    <button type="submit" class="basket_button"><i class="fa-solid fa-cart-shopping"></i></button>
                </a>

                <a href="/myprofile.html">
                    <button type="submit" class="login_button"><i class="fa-solid fa-user"></i></button>
                </a>
            </div>
        </div>
    </div>


    <div class="search_body">
        <div class="s_body_Term" id="searchTerm"></div>
        <div class="s_body_content_box" id="searchResults"></div>
    </div>

    <script>
        /*
        function getSearchTerm() {    //검색어 index.html에서 가져오는 함수
                var urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('q'); //검색어 return
        }

        $(document).ready(function() {
            var searchTerm = getSearchTerm();   //검색어

            //검색 결과 가져오기
            function displaySearchResults(searchTerm) { 
                $('#searchTerm').text(`'${searchTerm}'에 대한 검색 결과 `); // 검색어 키워드 화면에 띄움

                db.collection("product").get().then((결과) => {
                    var 템플릿 = "";
                    var 결과있음 = false;

                    결과.forEach((doc) => {
                        var product = doc.data();
                        if(product.제목.includes(searchTerm)) { // '제목' 필드에서 검색어를 포함하는지 확인
                            결과있음 = true;
                            
                            템플릿 +=
                            `<div class="s_result_products" >
                                <a href="/detail.html?id=${doc.id}" class="item_link" data-id="${doc.id}">
                                    <img class="p_image" src="${product.이미지1}">
                                    <h3 class="p_title">${product.제목}</h3>
                                    <p class="p_price">${product.가격}원</p>
                                    <p class="p_address">${product.주소}</p>
                                    <div class="like_chating">
                                        <span class="like">조회수 ${product.조회수}</span>
                                        <span>&nbsp;&nbsp;・&nbsp;&nbsp;</span>
                                        <span class="chat">채팅 ${product.채팅데이터}</span>
                                    </div>
                                </a>
                            </div>`;
                        } 
                    });
                    $('#searchResults').html(템플릿);
                    if(템플릿 == "") {
                        $('#searchTerm').text('등록된 상품이 없습니다');
                    }
                }).catch((error) => {
                    console.log("Error getting documents: ", error);
                });
            }
            if(searchTerm) {
                displaySearchResults(searchTerm);
            }
        });
        // 검색어 중 등록된 상품있는 경우만 db 저장한다.
        */

        $(document).ready(function() {
            var searchTerm = getSearchTerm();
            displaySearchResults(searchTerm);
        });

        function getSearchTerm() {
            var urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('q');
        }

        function displaySearchResults(searchTerm) {
            $('#searchTerm').text(`'${searchTerm}'에 대한 검색 결과 `);

            var 템플릿 = "";

            db.collection("product").get().then((결과) => {
                결과.forEach((doc) => {
                    var product = doc.data();
                    if (product.제목.includes(searchTerm)) {
                        템플릿 += createTemplate(doc.id, product, "product");
                    }
                });
                return db.collection("auction").get();
            }).then((결과) => {
                결과.forEach((doc) => {
                    var auction = doc.data();
                    if (auction.상품명.includes(searchTerm)) {
                        템플릿 += createTemplate(doc.id, auction, "auction");
                    }
                });

                if (템플릿 == "") {
                    $('#searchTerm').html('등록된 상품이 없습니다'); // 검색어 매칭 상품 없음
                } else {
                    $('#searchResults').html(템플릿); // 검색 결과(products) 띄우기
                    saveSearchTerm(searchTerm); // 검색 결과가 있을 경우에만 검색어 저장
                }
            }).catch((error) => {
                console.log("Error getting documents: ", error);
            });
        }

        function createTemplate(id, item, type) {

            var 제목 = (type === "product") ? item.제목 : item.상품명;
            var 가격 = (type === "product") ? item.가격 : item.현재입찰가;
            var 링크 = (type === "product") ? `/detail.html?id=${id}` : `/detail_auction.html?id=${id}`;
            
            return `
                <div class="s_result_products">
                    <a href="${링크}" class="item_link" data-id="${id}">
                        <img class="p_image" src="${item.이미지1}">
                        <h3 class="p_title">${제목}</h3>
                        <p class="p_price">${가격}원</p>
                        <div class="like_chating">
                            <span class="like">조회수 ${item.조회수}</span>
                            <span>&nbsp;&nbsp;・&nbsp;&nbsp;</span>
                            <span class="chat">채팅 ${item.채팅데이터}</span>
                        </div>
                    </a>
                </div>`;
        }

        function saveSearchTerm(searchTerm) {
            db.collection("searchHistory").where("searchWord", "==", searchTerm).get().then((결과) => {
                if (!결과.empty) {
                    결과.forEach((doc) => {
                        db.collection("searchHistory").doc(doc.id).update({
                            searchFrequency: firebase.firestore.FieldValue.increment(1),
                            searchTime: firebase.firestore.Timestamp.now()
                        });
                    });
                } else {
                    db.collection("searchHistory").add({
                        searchWord: searchTerm,
                        searchFrequency: 1,
                        searchTime: firebase.firestore.Timestamp.now()
                    });
                }
            }).catch((error) => {
                console.log("Error saving search term: ", error);
            });
        }
    </script>
</body>

</html>