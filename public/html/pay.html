<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/e1a2c43e41.js" crossorigin="anonymous"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>ON-MARKET</title>
</head>

<body>
    <!-- Firebase and jQuery scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Firebase configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY",
            authDomain: "FIREBASE_AUTH_DOMAIN",
            projectId: "FIREBASE_PROJECT_ID",
            storageBucket: "FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
            appId: "FIREBASE_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>   

    <div id="payBtn">
        <!--<button onclick="requestPay()">결제하기</button> -->
    </div>
        
    <!--iamport 설정-->
    <script src = "https://cdn.iamport.kr/js/iamport.payment-1.1.8.js"></script> 
    <script>
        async function fetchData() {    //async, await db 비동기 문제 처리.
            const IMP = window.IMP;
            IMP.init("IAMPORT_CODE");   // 아임포트 객체 초기화 

            var chatId = JSON.parse(localStorage.getItem("chatId")); // chatId 저장
            // chatId를 사용하여 productName 가져오기
            const chatdb = await db.collection("chat").doc(chatId).get();
            const productName = chatdb.data().product;
            // productName을 사용하여 productPrice, sellerName 저장
            let productPrice = 0;
            const productDB = await db.collection("product").where("제목", "==", productName).get();
            productDB.forEach(doc => {
                productPrice = doc.data().가격;
                sellerName = doc.data().판매자_이름;
                productId = doc.id;
                productImage = doc.data().이미지1;
            });

            // 구매자 정보 가져오기(이름, 이메일)
            var buyerId = JSON.parse(localStorage.getItem('user')).uid;
            const buyerDoc = await db.collection("user-id").doc(buyerId).get();
            const buyerName = buyerDoc.data().name;
            const buyerEmail = buyerDoc.data().email;

            // 결제된 상품 -> DB 담기 -> DB에서 상품id 조회=> [결제됐는지 확인] 
            await db.collection("order").where("상품_id", "==", productId).get().then( (결과)=> {
                if(!결과.empty){   
                alert("결제 완료된 상품입니다.");
                window.location.href = "/"
            }
            })
            
            //카카오페이 결제창
            IMP.request_pay({
                pg: "kakaopay.TC0ONETIME",
                pay_method: "card",
                merchant_uid: "merchant_"+ new Date().getTime(),
                name: productName,
                amount: productPrice,
                buyer_email: buyerEmail,
                buyer_name: buyerName,
                buyer_tel: "",
                buyer_addr: "",
                buyer_Id: buyerId,
                //m_redirect_ul: 
            },
            function(rsp){  //rsp.imp_uid 값으로 결제 단건조회 api호출 결제결과 판단
                if(rsp.success){    
                    db.collection("order").add({
                    //주문번호: merchant_uid,
                    상품_id: productId,
                    상품명: productName,
                    가격: productPrice,
                    판매자: sellerName, 
                    구매자: buyerName,
                    구매자_이메일: buyerEmail,
                    구매자_id: buyerId, 
                    주문상태: "결제완료",
                    이미지1: productImage,
                    타입: "product"
                    }).then( () => {
                        window.location.href ="/";  
                    }).catch((error) => {
                        console.error("DB 저장 실패:", error);
                        alert("결제 정보 저장 실패");
                    });
                //결제 실패시 
                } 
                else{
                    alert("결제 실패");  
                    window.location.href="/";
                }
            });
        }
        fetchData().catch(console.error); 
        /*
        $(document).ready(function(){
            $('#payBtn').click(function(){
                fetchData()
            })
        })
        */
    </script>
</body>
</html>
