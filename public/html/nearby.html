<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/e1a2c43e41.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>ON-MARKET</title>
    <link rel="icon" href="/images/5572662.png" type="/images/5572662.png">
    <link rel="stylesheet" href="../css/nearby.css">

    <script>
        // getUserLocation 함수 추가
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    }, (error) => {
                        reject(error);
                    });
                } else {
                    reject(new Error('Geolocation is not supported by this browser.'));
                }
            });
        }
    </script>
</head>

<body>
    <!-- Firebase and jQuery scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Firebase configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY",
            authDomain: "FIREBASE_AUTH_DOMAIN",
            projectId: "FIREBASE_PROJECT_ID",
            storageBucket: "FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
            appId: "FIREBASE_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <!-- Header -->
    <div class="header" style="margin-right: 15px;">
        <div class="header_wrap">
            <div class="header_content">
                <img src="/images/5572662.png" style="width: 80px; margin-top: 8px; padding-right: 10px;">
                <h1 style="margin-top: 19px; font-size: 27px; color: #f4511e; font-weight: bold;"><a href="/"
                        style="color: #f4511e; text-decoration: none;">ON</a></h1>
            </div>

            <div class="header_content">
                <a href="#">
                    <button type="submit" id="basketLink" class="basket_button"><i class="fa-solid fa-cart-shopping"></i></button>
                </a>

                <a href="/myprofile.html">
                    <button type="submit" id="profileLink" class="login_button"><i class="fa-solid fa-user"></i></button>
                </a>
            </div>
        </div>
    </div>

    <div class="contents">
        <div class="image-part">
            <img src="images/nearby.png">
        </div>

        <div class="main-contents">
            <h1>동네 이웃들이 자주 가는 동네 업체</h1>

            <ul class="navigator_menu_nearby">
                <li><a href="" class="category-restaurant" data-category="restaurant">식당</a></li>
                <li><a href="" class="category-cafe" data-category="cafe">카페</a></li>
                <li><a href="" class="category-beauty" data-category="beauty">뷰티/미용</a></li>
                <li><a href="" class="category-body" data-category="body">헬스/필라테스/요가</a></li>
            </ul>
        </div>

        <div id="posts" style="margin-top: 20px;">
            <ul id="postList"></ul>
        </div>

        <div class="businessAccount" style="margin-bottom: 10px; ">
            <a href="/businessLogin.html" style="margin: 5px;"><button class="businessAccount_button">비즈니스 계정
                    만들기</button></a>
            <a href="/nearby.html" style="margin: 5px;" onclick="showAlert();"><button class="myStore_button"
                    id="myStore_button">내 가게 추가하기</button></a>
        </div>
    </div>

    <script>
        $(document).ready(async function () {
            $('#basketLink').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html"; // 로그인 페이지로 리다이렉션
                    } else {
                        window.location.href = "/myprofile.html"; // 로그인이 되어 있다면, myprofile.html로 이동
                    }
                });
            });
            $('#profileLink').click(function (event) {
                event.preventDefault();
                firebase.auth().onAuthStateChanged((user) => {
                    if (!user) {
                        alert("로그인 후 이용해주세요.");
                        window.location.href = "/login.html"; // 로그인 페이지로 리다이렉션
                    } else {
                        window.location.href = "/myprofile.html"; // 로그인이 되어 있다면, myprofile.html로 이동
                    }
                });
            });
        });
    </script>

    <script>
        function showAlert() {
            alert("ON-비즈니스 이메일로 문의 해주시기 바랍니다!\n담당자 이메일: biz@onbiz.com");
        }

        // 거리 계산 함수 (Haversine formula)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; // Distance in km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }


        // 식당 카테고리를 클릭했을 때의 이벤트 핸들러
        $(document).ready(async function () {
            // 식당 카테고리 클릭 핸들러
            $('.category-restaurant').click(async function (e) {
                e.preventDefault();
                $('.navigator_menu_nearby li a').removeClass('category-selected');
                $(this).addClass('category-selected');
                $('#postList').empty();

                try {
                    const userLocation = await getUserLocation();
                    console.log('사용자의 위치:', userLocation); // 사용자의 위치 콘솔 출력

                    const maxDistance = 15; // 최대 거리 (킬로미터 단위)

                    db.collection('store').where('식당', '==', true).get().then((snapshot) => {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const distance = getDistanceFromLatLonInKm(userLocation.latitude, userLocation.longitude, data.latitude, data.longitude);
                            // 정보 데이터 가져오기
                            var info = doc.data().정보;
                            // 정보 데이터가 25자를 초과하는 경우 줄 바꿈 적용
                            if (info.length > 28) {
                                // 25자마다 줄 바꿈 처리
                                var splitInfo = info.match(/.{1,28}/g).join("<br>");
                                info = splitInfo;
                            }
                            if (distance <= maxDistance) {
                                var postTemplate = `
                            <li class="storePost">
                                <a href="/nearbyDetail.html?id=${doc.id}" style="text-decoration: none;" data-id="${doc.id}">
                                    <div class="card">
                                        <div class="card-header" style="display: flex; background-color: #e8faf6;">
                                            <img src="${doc.data().로고}" style="display: flex; object-fit: cover; width: 50px; height: 50px; align-items: center; border-radius: 50%; margin-right: 15px;">
                                            <h2 style="margin-top: 5px;">${doc.data().상호명}</h2>
                                        </div>
                                        <div class="card-body">
                                            <p class="location" style="font-size: 18px;">${doc.data().위치}</p>
                                            <p class="info">${data.정보}</p>
                                        </div>
                                    </div>
                                </a>
                            </li>`;
                                $('#postList').append(postTemplate);
                            }
                        });
                    });
                } catch (error) {
                    console.error('위치 가져오기 오류:', error);
                }
            });
        });


        // 카페 카테고리를 클릭했을 때의 이벤트 핸들러
        $(document).ready(async function () {
            // 카페 카테고리 클릭 핸들러
            $('.category-cafe').click(async function (e) {
                e.preventDefault();
                $('.navigator_menu_nearby li a').removeClass('category-selected');
                $(this).addClass('category-selected');
                $('#postList').empty();

                try {
                    const userLocation = await getUserLocation();
                    console.log('사용자의 위치:', userLocation); // 사용자의 위치 콘솔 출력

                    const maxDistance = 15; // 최대 거리 (킬로미터 단위)

                    db.collection('store').where('카페', '==', true).get().then((snapshot) => {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const distance = getDistanceFromLatLonInKm(userLocation.latitude, userLocation.longitude, data.latitude, data.longitude);
                            // 정보 데이터 가져오기
                            var info = doc.data().정보;
                            // 정보 데이터가 25자를 초과하는 경우 줄 바꿈 적용
                            if (info.length > 28) {
                                // 25자마다 줄 바꿈 처리
                                var splitInfo = info.match(/.{1,28}/g).join("<br>");
                                info = splitInfo;
                            }
                            if (distance <= maxDistance) {
                                var postTemplate = `
                            <li class="storePost">
                                <a href="/nearbyDetail.html?id=${doc.id}" style="text-decoration: none;" data-id="${doc.id}">
                                    <div class="card">
                                        <div class="card-header" style="display: flex; background-color: #e8faf6;">
                                            <img src="${doc.data().로고}" style="display: flex; object-fit: cover; width: 50px; height: 50px; align-items: center; border-radius: 50%; margin-right: 15px;">
                                            <h2 style="margin-top: 5px;">${doc.data().상호명}</h2>
                                        </div>
                                        <div class="card-body">
                                            <p class="location" style="font-size: 18px;">${doc.data().위치}</p>
                                            <p class="info">${data.정보}</p>
                                        </div>
                                    </div>
                                </a>
                            </li>`;
                                $('#postList').append(postTemplate);
                            }
                        });
                    });
                } catch (error) {
                    console.error('위치 가져오기 오류:', error);
                }
            });
        });

        // 미용 카테고리를 클릭했을 때의 이벤트 핸들러
        $(document).ready(async function () {
            // 뷰티/미용 카테고리 클릭 핸들러
            $('.category-beauty').click(async function (e) {
                e.preventDefault();
                $('.navigator_menu_nearby li a').removeClass('category-selected');
                $(this).addClass('category-selected');
                $('#postList').empty();

                try {
                    const userLocation = await getUserLocation();
                    console.log('사용자의 위치:', userLocation); // 사용자의 위치 콘솔 출력

                    const maxDistance = 15; // 최대 거리 (킬로미터 단위)

                    db.collection('store').where('미용', '==', true).get().then((snapshot) => {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const distance = getDistanceFromLatLonInKm(userLocation.latitude, userLocation.longitude, data.latitude, data.longitude);
                            // 정보 데이터 가져오기
                            var info = doc.data().정보;
                            // 정보 데이터가 25자를 초과하는 경우 줄 바꿈 적용
                            if (info.length > 28) {
                                // 25자마다 줄 바꿈 처리
                                var splitInfo = info.match(/.{1,28}/g).join("<br>");
                                info = splitInfo;
                            }
                            if (distance <= maxDistance) {
                                var postTemplate = `
                            <li class="storePost">
                                <a href="/nearbyDetail.html?id=${doc.id}" style="text-decoration: none;" data-id="${doc.id}">
                                    <div class="card">
                                        <div class="card-header" style="display: flex; background-color: #e8faf6;">
                                            <img src="${doc.data().로고}" style="display: flex; object-fit: cover; width: 50px; height: 50px; align-items: center; border-radius: 50%; margin-right: 15px;">
                                            <h2 style="margin-top: 5px;">${doc.data().상호명}</h2>
                                        </div>
                                        <div class="card-body">
                                            <p class="location" style="font-size: 18px;">${doc.data().위치}</p>
                                            <p class="info">${data.정보}</p>
                                        </div>
                                    </div>
                                </a>
                            </li>`;
                                $('#postList').append(postTemplate);
                            }
                        });
                    });
                } catch (error) {
                    console.error('위치 가져오기 오류:', error);
                }
            });
        });

        $(document).ready(async function () {
            // 뷰티 카테고리 클릭 핸들러
            $('.category-beauty').click(async function (e) {
                e.preventDefault();
                $('.navigator_menu_nearby li a').removeClass('category-selected');
                $(this).addClass('category-selected');
                $('#postList').empty();

                try {
                    const userLocation = await getUserLocation();
                    console.log('사용자의 위치:', userLocation); // 사용자의 위치 콘솔 출력

                    const maxDistance = 15; // 최대 거리 (킬로미터 단위)

                    db.collection('store').where('뷰티', '==', true).get().then((snapshot) => {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const distance = getDistanceFromLatLonInKm(userLocation.latitude, userLocation.longitude, data.latitude, data.longitude);
                            // 정보 데이터 가져오기
                            var info = doc.data().정보;
                            // 정보 데이터가 25자를 초과하는 경우 줄 바꿈 적용
                            if (info.length > 28) {
                                // 25자마다 줄 바꿈 처리
                                var splitInfo = info.match(/.{1,28}/g).join("<br>");
                                info = splitInfo;
                            }
                            if (distance <= maxDistance) {
                                var postTemplate = `
                            <li class="storePost">
                                <a href="/nearbyDetail.html?id=${doc.id}" style="text-decoration: none;" data-id="${doc.id}">
                                    <div class="card">
                                        <div class="card-header" style="display: flex; background-color: #e8faf6;">
                                            <img src="${doc.data().로고}" style="display: flex; object-fit: cover; width: 50px; height: 50px; align-items: center; border-radius: 50%; margin-right: 15px;">
                                            <h2 style="margin-top: 5px;">${doc.data().상호명}</h2>
                                        </div>
                                        <div class="card-body">
                                            <p class="location" style="font-size: 18px;">${doc.data().위치}</p>
                                            <p class="info">${data.정보}</p>
                                        </div>
                                    </div>
                                </a>
                            </li>`;
                                $('#postList').append(postTemplate);
                            }
                        });
                    });
                } catch (error) {
                    console.error('위치 가져오기 오류:', error);
                }
            });
        });

        // 헬스/필라테스/요가 카테고리를 클릭했을 때의 이벤트 핸들러
        $(document).ready(async function () {
            // 뷰티 카테고리 클릭 핸들러
            $('.category-body').click(async function (e) {
                e.preventDefault();
                $('.navigator_menu_nearby li a').removeClass('category-selected');
                $(this).addClass('category-selected');
                $('#postList').empty();

                try {
                    const userLocation = await getUserLocation();
                    console.log('사용자의 위치:', userLocation); // 사용자의 위치 콘솔 출력

                    const maxDistance = 15; // 최대 거리 (킬로미터 단위)

                    db.collection('store').where('헬스', '==', true).get().then((snapshot) => {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const distance = getDistanceFromLatLonInKm(userLocation.latitude, userLocation.longitude, data.latitude, data.longitude);
                            // 정보 데이터 가져오기
                            var info = doc.data().정보;
                            // 정보 데이터가 25자를 초과하는 경우 줄 바꿈 적용
                            if (info.length > 28) {
                                // 25자마다 줄 바꿈 처리
                                var splitInfo = info.match(/.{1,28}/g).join("<br>");
                                info = splitInfo;
                            }
                            if (distance <= maxDistance) {
                                var postTemplate = `
                            <li class="storePost">
                                <a href="/nearbyDetail.html?id=${doc.id}" style="text-decoration: none;" data-id="${doc.id}">
                                    <div class="card">
                                        <div class="card-header" style="display: flex; background-color: #e8faf6;">
                                            <img src="${doc.data().로고}" style="display: flex; object-fit: cover; width: 50px; height: 50px; align-items: center; border-radius: 50%; margin-right: 15px;">
                                            <h2 style="margin-top: 5px;">${doc.data().상호명}</h2>
                                        </div>
                                        <div class="card-body">
                                            <p class="location" style="font-size: 18px;">${doc.data().위치}</p>
                                            <p class="info">${data.정보}</p>
                                        </div>
                                    </div>
                                </a>
                            </li>`;
                                $('#postList').append(postTemplate);
                            }
                        });
                    });
                } catch (error) {
                    console.error('위치 가져오기 오류:', error);
                }
            });
        });

        $(document).ready(async function () {
            // 뷰티 카테고리 클릭 핸들러
            $('.category-body').click(async function (e) {
                e.preventDefault();
                $('.navigator_menu_nearby li a').removeClass('category-selected');
                $(this).addClass('category-selected');
                $('#postList').empty();

                try {
                    const userLocation = await getUserLocation();
                    console.log('사용자의 위치:', userLocation); // 사용자의 위치 콘솔 출력

                    const maxDistance = 15; // 최대 거리 (킬로미터 단위)

                    db.collection('store').where('필라테스', '==', true).get().then((snapshot) => {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const distance = getDistanceFromLatLonInKm(userLocation.latitude, userLocation.longitude, data.latitude, data.longitude);
                            // 정보 데이터 가져오기
                            var info = doc.data().정보;
                            // 정보 데이터가 25자를 초과하는 경우 줄 바꿈 적용
                            if (info.length > 28) {
                                // 25자마다 줄 바꿈 처리
                                var splitInfo = info.match(/.{1,28}/g).join("<br>");
                                info = splitInfo;
                            }
                            if (distance <= maxDistance) {
                                var postTemplate = `
                            <li class="storePost">
                                <a href="/nearbyDetail.html?id=${doc.id}" style="text-decoration: none;" data-id="${doc.id}">
                                    <div class="card">
                                        <div class="card-header" style="display: flex; background-color: #e8faf6;">
                                            <img src="${doc.data().로고}" style="display: flex; object-fit: cover; width: 50px; height: 50px; align-items: center; border-radius: 50%; margin-right: 15px;">
                                            <h2 style="margin-top: 5px;">${doc.data().상호명}</h2>
                                        </div>
                                        <div class="card-body">
                                            <p class="location" style="font-size: 18px;">${doc.data().위치}</p>
                                            <p class="info">${data.정보}</p>
                                        </div>
                                    </div>
                                </a>
                            </li>`;
                                $('#postList').append(postTemplate);
                            }
                        });
                    });
                } catch (error) {
                    console.error('위치 가져오기 오류:', error);
                }
            });
        });

        document.getElementById('myStore_button').addEventListener('click', function () {
            // 파일 URL
            const fileUrl = 'form/ON-Market Business 폼.hwp'; // 여기서 다운로드할 파일의 URL을 입력하세요.

            // 다운로드 링크 생성
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = 'ON-Market Business 폼.hwp'; // 다운로드될 파일의 이름을 지정하세요.

            // 링크 클릭 트리거
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>

</html>